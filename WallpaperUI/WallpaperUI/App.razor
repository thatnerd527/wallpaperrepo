<FluentDialogProvider />
<FluentTooltipProvider />
<FluentDesignTheme Mode="DesignThemeModes.System" CustomColor="#ff0000" OfficeColor="OfficeColor.OneNote" />
<Router AppAssembly="@typeof(App).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
    </Found>
    <NotFound>
        <PageTitle>Not found</PageTitle>
        <LayoutView Layout="@typeof(MainLayout)">
            <p role="alert">Sorry, there's nothing at this address.</p>
        </LayoutView>
    </NotFound>
</Router>
@if (!enableSelection)
{
    <style>
        * {
            user-select: none;
            pointer-events: none;
        }
    </style>
}
@using System.Text.Json;
@using System.Dynamic;
@using WallpaperUI.Pages;
@using Google.Protobuf;
@inject IJSRuntime JS
@code {
    public static App Instance = null;
    public bool enableSelection = true;
    public PreferencesManager preferencesManager = new PreferencesManager();
    private IJSObjectReference panelSystem;
    private IJSObjectReference backgroundSystem;
    private IJSObjectReference preferencesSystem;
    private IJSObjectReference restartSystem;
    public int controlPort = 0;
    private bool loopBreak = false;
    protected override async Task OnInitializedAsync()
    {
        Instance = this;
        preferencesManager.AddWriteHandler(async (x) =>
        {
            if (loopBreak)
            {
                return x;
            }
            await SavePreferences(preferencesManager);
            return x;
        });
    }

    private static Dictionary<string, MouseHandler> mouseHandlers = new Dictionary<string, MouseHandler>();

    private static Dictionary<string, MouseUpHandler> mouseUpHandlers = new Dictionary<string, MouseUpHandler>();

    [JSInvokable]
    public static void GlobalMouseMove(double[] doubles)
    {
        // This method is called from JavaScript.
        // The parameter is a JavaScript array that contains the mouse coordinates.
        // The array is marshaled to a .NET array of doubles.

        double clientX = doubles[0];
        double clientY = doubles[1];
        double pageX = doubles[2];
        double pageY = doubles[3];
        double screenX = doubles[4];
        double screenY = doubles[5];
        double movementX = doubles[6];
        double movementY = doubles[7];
        double offsetX = doubles[8];
        double offsetY = doubles[9];
        MouseEvent mouseEvent = new MouseEvent(clientX, clientY, screenX, screenY, pageX, pageY, offsetX, offsetY, movementX, movementY);
        foreach (var handler in mouseHandlers.Values)
        {
            handler.Invoke(mouseEvent);
        }

    }

    [JSInvokable]
    public static void UpdatePreferences(byte[] data)
    {
        if (data.Length == 0)
        {
            return;
        }
        var parsed = Wallpaper.CommonLanguage.AppSettings.Parser.ParseFrom(data)!;
        var data2 = parsed!;
        App.Instance.loopBreak = true;
        Instance.preferencesManager.Write(async (x) => parsed);
        App.Instance.loopBreak = false;
    }

    public static async Task SavePreferences(PreferencesManager pm)
    {
        using (var stream = new MemoryStream())
        {
            pm.Value.WriteTo(stream);
            var bytes = stream.ToArray();
            await Instance.preferencesSystem.InvokeVoidAsync("send", bytes);
        }
    }

    [JSInvokable]
    public static void GlobalMouseUp()
    {

        //Console.WriteLine("GlobalMouseUp");
        foreach (var handler in mouseUpHandlers.Values)
        {
            handler.Invoke();
        }

    }

    [JSInvokable]
    public static void PassControlPort(int port)
    {
        Instance.controlPort = port;
    }

    [JSInvokable]
    public static void UpdateAddonData(string data)
    {
        JsonElement result = JsonSerializer.Deserialize<JsonElement>(data)!;
        var lastActiveAddons = result.EnumerateArray().Select(x =>
    {
    return AddonManifest.FromJsonElement(x);
    }).ToList();
        Home.addonManifests = lastActiveAddons;
        Home.Instance.UpdatePanelData();
        if (Addons.Instance != null)
        {
            Addons.Instance.Refresh();
        }

    }

    [JSInvokable]
    public static void UpdateDisabledAddonData(string data)
    {
        JsonElement result = JsonSerializer.Deserialize<JsonElement>(data)!;
        var disabledAddons = result.EnumerateArray().Select(x =>
    {
    return AddonManifest.FromJsonElement(x);
    });
        Home.disabledAddons = disabledAddons.ToList();
        Home.Instance.UpdatePanelData();
        if (Addons.Instance != null)
        {
            Addons.Instance.Refresh();
        }

    }

    [JSInvokable]
    public static void UpdatePanelData(byte[] data)
    {
        if (data.Length == 0)
        {
            return;
        }
        var lastActivePanels = Wallpaper.CommonLanguage.RuntimePanelChangeRequest.Parser.ParseFrom(data);
        Home.panels = lastActivePanels.PanelChanges.ToList();
        Home.Instance.UpdatePanelData();
        if (Panels.Instance != null)
        {
            Panels.Instance.Refresh();
        }
    }

    [JSInvokable]
    public static void UpdateBackgroundData(byte[] data)
    {
        if (data.Length == 0)
        {
            return;
        }
        var lastActiveBackgrounds = Wallpaper.CommonLanguage.RuntimeBackgroundChangeRequest.Parser.ParseFrom(data);
        Home.backgrounds = lastActiveBackgrounds.NewBackgrounds.ToList();
        Home.currentBackground = lastActiveBackgrounds.NewActiveBackgroundID;

        Home.Instance.UpdatePanelData();
        if (Backgrounds.Instance != null)
        {
            Backgrounds.Instance.Refresh();
        }
    }

    [JSInvokable]
    public static void LoadPanelData(byte[] data)
    {
        if (data.Length == 0)
        {
            return;
        }
        var parsed = Wallpaper.CommonLanguage.PanelSystemInitialResponse.Parser.ParseFrom(data);
        Console.WriteLine(parsed);
        Home.SetData(parsed.InstancedButBlankPanels.ToList(), parsed.TemplatePanels.ToList(), parsed.InstancedPanelsFromStorage.ToList(), parsed.DeletedInstancedPanels.ToList());
        var embeddedpanels = parsed.InstancedButBlankPanels.Where(x => x.BasePanel.PanelType == "Embedded").ToList();
        if (Panels.Instance != null)
        {
            Panels.Instance.Refresh();
        }
    }

    [JSInvokable]
    public static void LoadBackgroundData(byte[] data)
    {
        if (data.Length == 0)
        {
            return;
        }
        var parsed = Wallpaper.CommonLanguage.BackgroundSystemInitialResponse.Parser.ParseFrom(data);
        Console.WriteLine(parsed);
        Home.SetBackgroundData(parsed.InstancedButBlankBackgrounds.ToList(), parsed.TemplateBackgrounds.ToList(), parsed.InstancedBackgroundsFromStorage.ToList(), parsed.DeletedInstancedBackgrounds.ToList(), parsed.LastActiveBackgroundID);
        var embeddedBackgrounds = parsed.InstancedButBlankBackgrounds.Where(x => x.BaseBackground.BackgroundType == "Embedded").ToList();
        if (Backgrounds.Instance != null)
        {
            Backgrounds.Instance.Refresh();
        }
    }

    [JSInvokable]
    public static bool IsDevEnvironment()
    {
        #if DEBUG
    return true;
        #else
        return false;
        #endif
    }

    [JSInvokable]
    public static void PassPreferencesWebsocket(IJSInProcessObjectReference ws)
    {
        Instance.preferencesSystem = ws;
    }

    [JSInvokable]
    public static void PassPanelWebsocket(IJSInProcessObjectReference ws)
    {
        Instance.panelSystem = ws;
    }

    [JSInvokable]
    public static void PassRestartWebsocket(IJSInProcessObjectReference ws)
    {
        Instance.restartSystem = ws;
    }

    [JSInvokable]
    public static void PassBackgroundWebsocket(IJSInProcessObjectReference ws)
    {
        Instance.backgroundSystem = ws;
    }

    public static void SaveBackgroundData(List<Wallpaper.CommonLanguage.RuntimeBackground> panels)
    {
        Console.WriteLine("Saving background data");
        var request = new Wallpaper.CommonLanguage.RuntimeBackgroundChangeRequest();
        request.NewBackgrounds.AddRange(Home.backgrounds);
        request.NewActiveBackgroundID = Home.currentBackground;
        using (var stream = new MemoryStream())
        {
            request.WriteTo(stream);
            var bytes = stream.ToArray();
            Instance.backgroundSystem.InvokeVoidAsync("send", bytes);
        }
    }

    public static void SavePanelData(List<Wallpaper.CommonLanguage.RuntimePanel> panels)
    {
        Console.WriteLine("Saving panel data");
        var serialized = new Wallpaper.CommonLanguage.RuntimePanelChangeRequest();
        serialized.PanelChanges.AddRange(panels);
        using (var stream = new MemoryStream())
        {
            serialized.WriteTo(stream);
            var bytes = stream.ToArray();
            Instance.panelSystem.InvokeVoidAsync("send", bytes);
        }
    }

    public static void DisableSelection()
    {
        Instance.enableSelection = false;
        Instance.StateHasChanged();
    }

    public static void EnableSelection()
    {
        Instance.enableSelection = true;
        Instance.StateHasChanged();
    }

    public static MouseHandler CreateMouseHandler(Action<MouseEvent> action)
    {
        string id = Guid.NewGuid().ToString();
        MouseHandler handler = new MouseHandler(action, () =>
        {
            mouseHandlers.Remove(id);
            mouseHandlers.Clear();
        });
        mouseHandlers.Add(id, handler);
        return handler;
    }

    public static MouseUpHandler CreateMouseUpHandler(Action action)
    {
        string id = Guid.NewGuid().ToString();
        MouseUpHandler handler = new MouseUpHandler(action, () =>
        {
            mouseUpHandlers.Remove(id);
            mouseUpHandlers.Clear();
        });
        mouseUpHandlers.Add(id, handler);
        return handler;
    }


}