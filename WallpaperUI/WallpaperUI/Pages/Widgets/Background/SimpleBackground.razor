@using System.Text.Json
@RenderInternals()

@inject IJSRuntime JS
@code {

    protected override async Task OnInitializedAsync()
    {
        App.Instance.preferencesManager.AddWriteHandler(async (x) =>
        {

            uniqueId = Guid.NewGuid().ToString();
            StateHasChanged();
            return x;
        });

    }

    private int controlPort = 0;
    private string uniqueId = Guid.NewGuid().ToString();

    public string NameToType(string filename)
    {
        if (filename.EndsWith(".webm") || filename.EndsWith(".mp4")) {
            return "Video";
        } else if (
                  filename.EndsWith(".jpg") || filename.EndsWith(".jpeg") || filename.EndsWith(".png") || 
                  filename.EndsWith(".gif") || filename.EndsWith(".gifv") || filename.EndsWith(".svg") || 
                  filename.EndsWith(".bmp") || filename.EndsWith(".avif") || filename.EndsWith(".webp")
        )
        {
            return "Image";
        } else {
            return "Embedded";
        }
    }

    public RenderFragment RenderInternals()
    {
        if (controlPort == 0)
        {
            controlPort = App.Instance.controlPort;
        }

        if (!App.Instance.preferencesManager.SimpleBackgroundsSystem.IsSimpleBackgroundEnabled)
        {
            return @<div></div>;
        }
        else
        {
            var pref = App.Instance.preferencesManager.SimpleBackgroundsSystem.ActiveSimpleBackgroundID;
            var queried = App.Instance.preferencesManager.SimpleBackgroundsSystem.SimpleBackgrounds.FirstOrDefault(x => x.BackgroundID == pref);

            var res = RenderInternals2(queried);
            return @res;
        } 

    }



    private RenderFragment RenderInternals2(Wallpaper.CommonLanguage.SimpleBackground background)
    {
        //Console.WriteLine(runtimeCustomPanel.PanelType);
        switch (NameToType(background.FilePath))
        {
            case "Image":
                return @<img src="@($"http://127.0.0.1:{controlPort}/simplebackground?backgroundid={background.BackgroundID}")" class="pointer-events-none h-full w-full object-cover" />;
            case "Video":
                return@<div class="h-full w-full">
                            <video style="
                                                object-fit: cover;
                                                " id="backgroundvideo" class="pointer-events-none h-full w-full" src="@($"http://127.0.0.1:{controlPort}/simplebackground?backgroundid={background.BackgroundID}")" type="video/webm">

                            </video>
                            <script>
                                var video = document.getElementById('backgroundvideo')
                                video.muted = true;
                                video.loop = true;
                                video.play();
                                console.log(video)
                            </script>
                        </div>;
            default:
                return @<div>Unknown background type. </div>;
        }
    }
}